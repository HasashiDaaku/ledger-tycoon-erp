============================= test session starts =============================
platform win32 -- Python 3.13.5, pytest-9.0.2, pluggy-1.6.0 -- C:\Users\van Houten\accounting_erp_software\venv\Scripts\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\van Houten\accounting_erp_software\backend
configfile: pytest.ini
plugins: anyio-4.12.1, asyncio-1.3.0, cov-7.0.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 19 items

tests/test_inventory_manager.py::TestInventoryManager::test_init PASSED  [  5%]
tests/test_inventory_manager.py::TestInventoryManager::test_forecast_demand_no_history_no_market_avg PASSED [ 10%]
tests/test_inventory_manager.py::TestInventoryManager::test_forecast_demand_no_history_with_market_avg FAILED [ 15%]
tests/test_inventory_manager.py::TestInventoryManager::test_forecast_demand_with_history FAILED [ 21%]
tests/test_inventory_manager.py::TestInventoryManager::test_forecast_demand_with_fewer_periods_than_requested FAILED [ 26%]
tests/test_inventory_manager.py::TestInventoryManager::test_forecast_demand_with_events_engine FAILED [ 31%]
tests/test_inventory_manager.py::TestInventoryManager::test_forecast_demand_with_events_engine_no_product_name PASSED [ 36%]
tests/test_inventory_manager.py::TestInventoryManager::test_calculate_safety_stock_insufficient_data FAILED [ 42%]
tests/test_inventory_manager.py::TestInventoryManager::test_calculate_safety_stock_with_sufficient_data FAILED [ 47%]
tests/test_inventory_manager.py::TestInventoryManager::test_calculate_safety_stock_no_history PASSED [ 52%]
tests/test_inventory_manager.py::TestInventoryManager::test_get_current_inventory_exists PASSED [ 57%]
tests/test_inventory_manager.py::TestInventoryManager::test_get_current_inventory_not_exists PASSED [ 63%]
tests/test_inventory_manager.py::TestInventoryManager::test_get_reorder_quantity_needs_reorder FAILED [ 68%]
tests/test_inventory_manager.py::TestInventoryManager::test_get_reorder_quantity_no_reorder_needed FAILED [ 73%]
tests/test_inventory_manager.py::TestInventoryManager::test_get_reorder_quantity_with_events_engine FAILED [ 78%]
tests/test_inventory_manager.py::TestInventoryManager::test_calculate_turnover_with_sales_and_inventory FAILED [ 84%]
tests/test_inventory_manager.py::TestInventoryManager::test_calculate_turnover_no_sales PASSED [ 89%]
tests/test_inventory_manager.py::TestInventoryManager::test_calculate_turnover_no_inventory FAILED [ 94%]
tests/test_inventory_manager.py::TestInventoryManager::test_calculate_turnover_zero_inventory FAILED [100%]

================================== FAILURES ===================================
____ TestInventoryManager.test_forecast_demand_no_history_with_market_avg _____

self = <test_inventory_manager.TestInventoryManager object at 0x000001DED5887360>
inventory_manager = <core.inventory_manager.InventoryManager object at 0x000001DED595C190>
db_session = <sqlalchemy.orm.session.AsyncSession object at 0x000001DED58E1A90>
test_company = <app.models.Company object at 0x000001DED595D590>
test_product = <app.models.Product object at 0x000001DED595D1D0>

    async def test_forecast_demand_no_history_with_market_avg(self, inventory_manager, db_session, test_company, test_product):
        """Test forecast_demand when there's no company history but market average exists."""
        # Create market history for other companies
        other_company = Company(name="Other Co", is_player=False, cash=10000.0)
        db_session.add(other_company)
        await db_session.commit()
    
        # Add market history for other company
        for i in range(3):
>           history = MarketHistory(
                company_id=other_company.id,
                product_id=test_product.id,
                year=2024,
                month=i + 1,
                demand_captured=400.0 + i * 50,
                units_sold=350.0 + i * 50,
                revenue=7000.0,
                market_share=0.25
            )

tests\test_inventory_manager.py:37: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
<string>:4: in __init__
    ???
..\venv\Lib\site-packages\sqlalchemy\orm\state.py:596: in _initialize_instance
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
..\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
..\venv\Lib\site-packages\sqlalchemy\orm\state.py:594: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <app.models.MarketHistory object at 0x000001DED58E16A0>
kwargs = {'company_id': 2, 'demand_captured': 400.0, 'market_share': 0.25, 'month': 1, ...}
cls_ = <class 'app.models.MarketHistory'>, k = 'market_share'

    def _declarative_constructor(self: Any, **kwargs: Any) -> None:
        """A simple constructor that allows initialization from kwargs.
    
        Sets attributes on the constructed instance using the names and
        values in ``kwargs``.
    
        Only keys that are present as
        attributes of the instance's class are allowed. These could be,
        for example, any mapped columns or relationships.
        """
        cls_ = type(self)
        for k in kwargs:
            if not hasattr(cls_, k):
>               raise TypeError(
                    "%r is an invalid keyword argument for %s" % (k, cls_.__name__)
                )
E               TypeError: 'market_share' is an invalid keyword argument for MarketHistory

..\venv\Lib\site-packages\sqlalchemy\orm\decl_base.py:2179: TypeError
___________ TestInventoryManager.test_forecast_demand_with_history ____________

self = <test_inventory_manager.TestInventoryManager object at 0x000001DED58875C0>
inventory_manager = <core.inventory_manager.InventoryManager object at 0x000001DED59CF5C0>
db_session = <sqlalchemy.orm.session.AsyncSession object at 0x000001DED58E0980>
test_company = <app.models.Company object at 0x000001DED5AC5810>
test_product = <app.models.Product object at 0x000001DED595CCD0>

    async def test_forecast_demand_with_history(self, inventory_manager, db_session, test_company, test_product):
        """Test forecast_demand with historical data using weighted moving average."""
        # Create 3 periods of history
        demands = [300.0, 400.0, 500.0]  # Oldest to newest
        for i, demand in enumerate(demands):
>           history = MarketHistory(
                company_id=test_company.id,
                product_id=test_product.id,
                year=2024,
                month=i + 1,
                demand_captured=demand,
                units_sold=demand * 0.9,
                revenue=demand * 20,
                market_share=0.3
            )

tests\test_inventory_manager.py:61: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
<string>:4: in __init__
    ???
..\venv\Lib\site-packages\sqlalchemy\orm\state.py:596: in _initialize_instance
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
..\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
..\venv\Lib\site-packages\sqlalchemy\orm\state.py:594: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <app.models.MarketHistory object at 0x000001DED595D310>
kwargs = {'company_id': 1, 'demand_captured': 300.0, 'market_share': 0.3, 'month': 1, ...}
cls_ = <class 'app.models.MarketHistory'>, k = 'market_share'

    def _declarative_constructor(self: Any, **kwargs: Any) -> None:
        """A simple constructor that allows initialization from kwargs.
    
        Sets attributes on the constructed instance using the names and
        values in ``kwargs``.
    
        Only keys that are present as
        attributes of the instance's class are allowed. These could be,
        for example, any mapped columns or relationships.
        """
        cls_ = type(self)
        for k in kwargs:
            if not hasattr(cls_, k):
>               raise TypeError(
                    "%r is an invalid keyword argument for %s" % (k, cls_.__name__)
                )
E               TypeError: 'market_share' is an invalid keyword argument for MarketHistory

..\venv\Lib\site-packages\sqlalchemy\orm\decl_base.py:2179: TypeError
_ TestInventoryManager.test_forecast_demand_with_fewer_periods_than_requested _

self = <test_inventory_manager.TestInventoryManager object at 0x000001DED58AF770>
inventory_manager = <core.inventory_manager.InventoryManager object at 0x000001DED5AC4B00>
db_session = <sqlalchemy.orm.session.AsyncSession object at 0x000001DED5A09E80>
test_company = <app.models.Company object at 0x000001DED5AC6190>
test_product = <app.models.Product object at 0x000001DED5AC62C0>

    async def test_forecast_demand_with_fewer_periods_than_requested(self, inventory_manager, db_session, test_company, test_product):
        """Test forecast_demand when less history exists than periods_back."""
        # Create only 2 periods of history
        for i in range(2):
>           history = MarketHistory(
                company_id=test_company.id,
                product_id=test_product.id,
                year=2024,
                month=i + 1,
                demand_captured=400.0,
                units_sold=350.0,
                revenue=7000.0,
                market_share=0.25
            )

tests\test_inventory_manager.py:86: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
<string>:4: in __init__
    ???
..\venv\Lib\site-packages\sqlalchemy\orm\state.py:596: in _initialize_instance
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
..\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
..\venv\Lib\site-packages\sqlalchemy\orm\state.py:594: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <app.models.MarketHistory object at 0x000001DED595D6D0>
kwargs = {'company_id': 1, 'demand_captured': 400.0, 'market_share': 0.25, 'month': 1, ...}
cls_ = <class 'app.models.MarketHistory'>, k = 'market_share'

    def _declarative_constructor(self: Any, **kwargs: Any) -> None:
        """A simple constructor that allows initialization from kwargs.
    
        Sets attributes on the constructed instance using the names and
        values in ``kwargs``.
    
        Only keys that are present as
        attributes of the instance's class are allowed. These could be,
        for example, any mapped columns or relationships.
        """
        cls_ = type(self)
        for k in kwargs:
            if not hasattr(cls_, k):
>               raise TypeError(
                    "%r is an invalid keyword argument for %s" % (k, cls_.__name__)
                )
E               TypeError: 'market_share' is an invalid keyword argument for MarketHistory

..\venv\Lib\site-packages\sqlalchemy\orm\decl_base.py:2179: TypeError
________ TestInventoryManager.test_forecast_demand_with_events_engine _________

self = <test_inventory_manager.TestInventoryManager object at 0x000001DED5908AF0>
inventory_manager = <core.inventory_manager.InventoryManager object at 0x000001DED4722D50>
db_session = <sqlalchemy.orm.session.AsyncSession object at 0x000001DED58E1A90>
test_company = <app.models.Company object at 0x000001DED5A22F90>
test_product = <app.models.Product object at 0x000001DED59CEFD0>

    async def test_forecast_demand_with_events_engine(self, inventory_manager, db_session, test_company, test_product):
        """Test forecast_demand with events_engine applying modifiers."""
        # Create history
>       history = MarketHistory(
            company_id=test_company.id,
            product_id=test_product.id,
            year=2024,
            month=1,
            demand_captured=400.0,
            units_sold=350.0,
            revenue=7000.0,
            market_share=0.25
        )

tests\test_inventory_manager.py:109: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
<string>:4: in __init__
    ???
..\venv\Lib\site-packages\sqlalchemy\orm\state.py:596: in _initialize_instance
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
..\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
..\venv\Lib\site-packages\sqlalchemy\orm\state.py:594: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <app.models.MarketHistory object at 0x000001DED59CE650>
kwargs = {'company_id': 1, 'demand_captured': 400.0, 'market_share': 0.25, 'month': 1, ...}
cls_ = <class 'app.models.MarketHistory'>, k = 'market_share'

    def _declarative_constructor(self: Any, **kwargs: Any) -> None:
        """A simple constructor that allows initialization from kwargs.
    
        Sets attributes on the constructed instance using the names and
        values in ``kwargs``.
    
        Only keys that are present as
        attributes of the instance's class are allowed. These could be,
        for example, any mapped columns or relationships.
        """
        cls_ = type(self)
        for k in kwargs:
            if not hasattr(cls_, k):
>               raise TypeError(
                    "%r is an invalid keyword argument for %s" % (k, cls_.__name__)
                )
E               TypeError: 'market_share' is an invalid keyword argument for MarketHistory

..\venv\Lib\site-packages\sqlalchemy\orm\decl_base.py:2179: TypeError
_____ TestInventoryManager.test_calculate_safety_stock_insufficient_data ______

self = <test_inventory_manager.TestInventoryManager object at 0x000001DED5919450>
inventory_manager = <core.inventory_manager.InventoryManager object at 0x000001DED5A6D370>
db_session = <sqlalchemy.orm.session.AsyncSession object at 0x000001DED58E0980>
test_company = <app.models.Company object at 0x000001DED5A6C9E0>
test_product = <app.models.Product object at 0x000001DED5A23D10>

    async def test_calculate_safety_stock_insufficient_data(self, inventory_manager, db_session, test_company, test_product):
        """Test calculate_safety_stock with less than 2 data points."""
        # Create only 1 period of history
>       history = MarketHistory(
            company_id=test_company.id,
            product_id=test_product.id,
            year=2024,
            month=1,
            demand_captured=400.0,
            units_sold=350.0,
            revenue=7000.0,
            market_share=0.25
        )

tests\test_inventory_manager.py:155: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
<string>:4: in __init__
    ???
..\venv\Lib\site-packages\sqlalchemy\orm\state.py:596: in _initialize_instance
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
..\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
..\venv\Lib\site-packages\sqlalchemy\orm\state.py:594: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <app.models.MarketHistory object at 0x000001DED59CFE10>
kwargs = {'company_id': 1, 'demand_captured': 400.0, 'market_share': 0.25, 'month': 1, ...}
cls_ = <class 'app.models.MarketHistory'>, k = 'market_share'

    def _declarative_constructor(self: Any, **kwargs: Any) -> None:
        """A simple constructor that allows initialization from kwargs.
    
        Sets attributes on the constructed instance using the names and
        values in ``kwargs``.
    
        Only keys that are present as
        attributes of the instance's class are allowed. These could be,
        for example, any mapped columns or relationships.
        """
        cls_ = type(self)
        for k in kwargs:
            if not hasattr(cls_, k):
>               raise TypeError(
                    "%r is an invalid keyword argument for %s" % (k, cls_.__name__)
                )
E               TypeError: 'market_share' is an invalid keyword argument for MarketHistory

..\venv\Lib\site-packages\sqlalchemy\orm\decl_base.py:2179: TypeError
____ TestInventoryManager.test_calculate_safety_stock_with_sufficient_data ____

self = <test_inventory_manager.TestInventoryManager object at 0x000001DED5919650>
inventory_manager = <core.inventory_manager.InventoryManager object at 0x000001DED5A8C350>
db_session = <sqlalchemy.orm.session.AsyncSession object at 0x000001DED5A09D30>
test_company = <app.models.Company object at 0x000001DED5A8DB50>
test_product = <app.models.Product object at 0x000001DED5A6C7C0>

    async def test_calculate_safety_stock_with_sufficient_data(self, inventory_manager, db_session, test_company, test_product):
        """Test calculate_safety_stock with sufficient historical data."""
        # Create 3 periods with varying demand
        demands = [300.0, 400.0, 500.0]
        for i, demand in enumerate(demands):
>           history = MarketHistory(
                company_id=test_company.id,
                product_id=test_product.id,
                year=2024,
                month=i + 1,
                demand_captured=demand,
                units_sold=demand * 0.9,
                revenue=demand * 20,
                market_share=0.3
            )

tests\test_inventory_manager.py:178: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
<string>:4: in __init__
    ???
..\venv\Lib\site-packages\sqlalchemy\orm\state.py:596: in _initialize_instance
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
..\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
..\venv\Lib\site-packages\sqlalchemy\orm\state.py:594: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <app.models.MarketHistory object at 0x000001DED5A9CCB0>
kwargs = {'company_id': 1, 'demand_captured': 300.0, 'market_share': 0.3, 'month': 1, ...}
cls_ = <class 'app.models.MarketHistory'>, k = 'market_share'

    def _declarative_constructor(self: Any, **kwargs: Any) -> None:
        """A simple constructor that allows initialization from kwargs.
    
        Sets attributes on the constructed instance using the names and
        values in ``kwargs``.
    
        Only keys that are present as
        attributes of the instance's class are allowed. These could be,
        for example, any mapped columns or relationships.
        """
        cls_ = type(self)
        for k in kwargs:
            if not hasattr(cls_, k):
>               raise TypeError(
                    "%r is an invalid keyword argument for %s" % (k, cls_.__name__)
                )
E               TypeError: 'market_share' is an invalid keyword argument for MarketHistory

..\venv\Lib\site-packages\sqlalchemy\orm\decl_base.py:2179: TypeError
________ TestInventoryManager.test_get_reorder_quantity_needs_reorder _________

self = <test_inventory_manager.TestInventoryManager object at 0x000001DED591F310>
inventory_manager = <core.inventory_manager.InventoryManager object at 0x000001DED47CBD90>
db_session = <sqlalchemy.orm.session.AsyncSession object at 0x000001DED58E16A0>
test_company = <app.models.Company object at 0x000001DED5A36430>
test_product = <app.models.Product object at 0x000001DED5E52990>

    async def test_get_reorder_quantity_needs_reorder(self, inventory_manager, db_session, test_company, test_product):
        """Test get_reorder_quantity when reorder is needed."""
        # Create history for forecast
>       history = MarketHistory(
            company_id=test_company.id,
            product_id=test_product.id,
            year=2024,
            month=1,
            demand_captured=400.0,
            units_sold=350.0,
            revenue=7000.0,
            market_share=0.25
        )

tests\test_inventory_manager.py:231: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
<string>:4: in __init__
    ???
..\venv\Lib\site-packages\sqlalchemy\orm\state.py:596: in _initialize_instance
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
..\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
..\venv\Lib\site-packages\sqlalchemy\orm\state.py:594: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <app.models.MarketHistory object at 0x000001DED5973CE0>
kwargs = {'company_id': 1, 'demand_captured': 400.0, 'market_share': 0.25, 'month': 1, ...}
cls_ = <class 'app.models.MarketHistory'>, k = 'market_share'

    def _declarative_constructor(self: Any, **kwargs: Any) -> None:
        """A simple constructor that allows initialization from kwargs.
    
        Sets attributes on the constructed instance using the names and
        values in ``kwargs``.
    
        Only keys that are present as
        attributes of the instance's class are allowed. These could be,
        for example, any mapped columns or relationships.
        """
        cls_ = type(self)
        for k in kwargs:
            if not hasattr(cls_, k):
>               raise TypeError(
                    "%r is an invalid keyword argument for %s" % (k, cls_.__name__)
                )
E               TypeError: 'market_share' is an invalid keyword argument for MarketHistory

..\venv\Lib\site-packages\sqlalchemy\orm\decl_base.py:2179: TypeError
______ TestInventoryManager.test_get_reorder_quantity_no_reorder_needed _______

self = <test_inventory_manager.TestInventoryManager object at 0x000001DED57DC390>
inventory_manager = <core.inventory_manager.InventoryManager object at 0x000001DED5A91550>
db_session = <sqlalchemy.orm.session.AsyncSession object at 0x000001DED58E0980>
test_company = <app.models.Company object at 0x000001DED5A36350>
test_product = <app.models.Product object at 0x000001DED5E534D0>

    async def test_get_reorder_quantity_no_reorder_needed(self, inventory_manager, db_session, test_company, test_product):
        """Test get_reorder_quantity when inventory is sufficient."""
        # Create history
>       history = MarketHistory(
            company_id=test_company.id,
            product_id=test_product.id,
            year=2024,
            month=1,
            demand_captured=400.0,
            units_sold=350.0,
            revenue=7000.0,
            market_share=0.25
        )

tests\test_inventory_manager.py:261: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
<string>:4: in __init__
    ???
..\venv\Lib\site-packages\sqlalchemy\orm\state.py:596: in _initialize_instance
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
..\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
..\venv\Lib\site-packages\sqlalchemy\orm\state.py:594: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <app.models.MarketHistory object at 0x000001DED5A6CC00>
kwargs = {'company_id': 1, 'demand_captured': 400.0, 'market_share': 0.25, 'month': 1, ...}
cls_ = <class 'app.models.MarketHistory'>, k = 'market_share'

    def _declarative_constructor(self: Any, **kwargs: Any) -> None:
        """A simple constructor that allows initialization from kwargs.
    
        Sets attributes on the constructed instance using the names and
        values in ``kwargs``.
    
        Only keys that are present as
        attributes of the instance's class are allowed. These could be,
        for example, any mapped columns or relationships.
        """
        cls_ = type(self)
        for k in kwargs:
            if not hasattr(cls_, k):
>               raise TypeError(
                    "%r is an invalid keyword argument for %s" % (k, cls_.__name__)
                )
E               TypeError: 'market_share' is an invalid keyword argument for MarketHistory

..\venv\Lib\site-packages\sqlalchemy\orm\decl_base.py:2179: TypeError
______ TestInventoryManager.test_get_reorder_quantity_with_events_engine ______

self = <test_inventory_manager.TestInventoryManager object at 0x000001DED58FC4D0>
inventory_manager = <core.inventory_manager.InventoryManager object at 0x000001DED5AB1570>
db_session = <sqlalchemy.orm.session.AsyncSession object at 0x000001DED58E16A0>
test_company = <app.models.Company object at 0x000001DED5AB17E0>
test_product = <app.models.Product object at 0x000001DED59F5C50>

    async def test_get_reorder_quantity_with_events_engine(self, inventory_manager, db_session, test_company, test_product):
        """Test get_reorder_quantity with events_engine modifying forecast."""
        # Create history
>       history = MarketHistory(
            company_id=test_company.id,
            product_id=test_product.id,
            year=2024,
            month=1,
            demand_captured=400.0,
            units_sold=350.0,
            revenue=7000.0,
            market_share=0.25
        )

tests\test_inventory_manager.py:290: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
<string>:4: in __init__
    ???
..\venv\Lib\site-packages\sqlalchemy\orm\state.py:596: in _initialize_instance
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
..\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
..\venv\Lib\site-packages\sqlalchemy\orm\state.py:594: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <app.models.MarketHistory object at 0x000001DED5A24C50>
kwargs = {'company_id': 1, 'demand_captured': 400.0, 'market_share': 0.25, 'month': 1, ...}
cls_ = <class 'app.models.MarketHistory'>, k = 'market_share'

    def _declarative_constructor(self: Any, **kwargs: Any) -> None:
        """A simple constructor that allows initialization from kwargs.
    
        Sets attributes on the constructed instance using the names and
        values in ``kwargs``.
    
        Only keys that are present as
        attributes of the instance's class are allowed. These could be,
        for example, any mapped columns or relationships.
        """
        cls_ = type(self)
        for k in kwargs:
            if not hasattr(cls_, k):
>               raise TypeError(
                    "%r is an invalid keyword argument for %s" % (k, cls_.__name__)
                )
E               TypeError: 'market_share' is an invalid keyword argument for MarketHistory

..\venv\Lib\site-packages\sqlalchemy\orm\decl_base.py:2179: TypeError
____ TestInventoryManager.test_calculate_turnover_with_sales_and_inventory ____

self = <test_inventory_manager.TestInventoryManager object at 0x000001DED58FC650>
inventory_manager = <core.inventory_manager.InventoryManager object at 0x000001DED5BA7050>
db_session = <sqlalchemy.orm.session.AsyncSession object at 0x000001DED58E1A90>
test_company = <app.models.Company object at 0x000001DED5BA7950>
test_product = <app.models.Product object at 0x000001DED5A9AA50>

    async def test_calculate_turnover_with_sales_and_inventory(self, inventory_manager, db_session, test_company, test_product):
        """Test calculate_turnover with sales and inventory data."""
        # Create sales history
        for i in range(3):
>           history = MarketHistory(
                company_id=test_company.id,
                product_id=test_product.id,
                year=2024,
                month=i + 1,
                demand_captured=400.0,
                units_sold=100.0,  # 100 units sold per period
                revenue=2000.0,
                market_share=0.25
            )

tests\test_inventory_manager.py:329: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
<string>:4: in __init__
    ???
..\venv\Lib\site-packages\sqlalchemy\orm\state.py:596: in _initialize_instance
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
..\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
..\venv\Lib\site-packages\sqlalchemy\orm\state.py:594: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <app.models.MarketHistory object at 0x000001DED5A8ED50>
kwargs = {'company_id': 1, 'demand_captured': 400.0, 'market_share': 0.25, 'month': 1, ...}
cls_ = <class 'app.models.MarketHistory'>, k = 'market_share'

    def _declarative_constructor(self: Any, **kwargs: Any) -> None:
        """A simple constructor that allows initialization from kwargs.
    
        Sets attributes on the constructed instance using the names and
        values in ``kwargs``.
    
        Only keys that are present as
        attributes of the instance's class are allowed. These could be,
        for example, any mapped columns or relationships.
        """
        cls_ = type(self)
        for k in kwargs:
            if not hasattr(cls_, k):
>               raise TypeError(
                    "%r is an invalid keyword argument for %s" % (k, cls_.__name__)
                )
E               TypeError: 'market_share' is an invalid keyword argument for MarketHistory

..\venv\Lib\site-packages\sqlalchemy\orm\decl_base.py:2179: TypeError
__________ TestInventoryManager.test_calculate_turnover_no_inventory __________

self = <test_inventory_manager.TestInventoryManager object at 0x000001DED57ECC00>
inventory_manager = <core.inventory_manager.InventoryManager object at 0x000001DED5A724C0>
db_session = <sqlalchemy.orm.session.AsyncSession object at 0x000001DED5A0A120>
test_company = <app.models.Company object at 0x000001DED5A72DB0>
test_product = <app.models.Product object at 0x000001DED5BA7A10>

    async def test_calculate_turnover_no_inventory(self, inventory_manager, db_session, test_company, test_product):
        """Test calculate_turnover when there is no inventory."""
        # Create sales but no inventory
>       history = MarketHistory(
            company_id=test_company.id,
            product_id=test_product.id,
            year=2024,
            month=1,
            demand_captured=400.0,
            units_sold=100.0,
            revenue=2000.0,
            market_share=0.25
        )

tests\test_inventory_manager.py:375: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
<string>:4: in __init__
    ???
..\venv\Lib\site-packages\sqlalchemy\orm\state.py:596: in _initialize_instance
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
..\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
..\venv\Lib\site-packages\sqlalchemy\orm\state.py:594: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <app.models.MarketHistory object at 0x000001DED59DE990>
kwargs = {'company_id': 1, 'demand_captured': 400.0, 'market_share': 0.25, 'month': 1, ...}
cls_ = <class 'app.models.MarketHistory'>, k = 'market_share'

    def _declarative_constructor(self: Any, **kwargs: Any) -> None:
        """A simple constructor that allows initialization from kwargs.
    
        Sets attributes on the constructed instance using the names and
        values in ``kwargs``.
    
        Only keys that are present as
        attributes of the instance's class are allowed. These could be,
        for example, any mapped columns or relationships.
        """
        cls_ = type(self)
        for k in kwargs:
            if not hasattr(cls_, k):
>               raise TypeError(
                    "%r is an invalid keyword argument for %s" % (k, cls_.__name__)
                )
E               TypeError: 'market_share' is an invalid keyword argument for MarketHistory

..\venv\Lib\site-packages\sqlalchemy\orm\decl_base.py:2179: TypeError
_________ TestInventoryManager.test_calculate_turnover_zero_inventory _________

self = <test_inventory_manager.TestInventoryManager object at 0x000001DED59004B0>
inventory_manager = <core.inventory_manager.InventoryManager object at 0x000001DED5A726D0>
db_session = <sqlalchemy.orm.session.AsyncSession object at 0x000001DED58E1A90>
test_company = <app.models.Company object at 0x000001DED5A72A40>
test_product = <app.models.Product object at 0x000001DED5AF1CD0>

    async def test_calculate_turnover_zero_inventory(self, inventory_manager, db_session, test_company, test_product):
        """Test calculate_turnover when inventory quantity is zero."""
        # Create sales and zero inventory
>       history = MarketHistory(
            company_id=test_company.id,
            product_id=test_product.id,
            year=2024,
            month=1,
            demand_captured=400.0,
            units_sold=100.0,
            revenue=2000.0,
            market_share=0.25
        )

tests\test_inventory_manager.py:396: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
<string>:4: in __init__
    ???
..\venv\Lib\site-packages\sqlalchemy\orm\state.py:596: in _initialize_instance
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
..\venv\Lib\site-packages\sqlalchemy\util\langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
..\venv\Lib\site-packages\sqlalchemy\orm\state.py:594: in _initialize_instance
    manager.original_init(*mixed[1:], **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <app.models.MarketHistory object at 0x000001DED5E51E50>
kwargs = {'company_id': 1, 'demand_captured': 400.0, 'market_share': 0.25, 'month': 1, ...}
cls_ = <class 'app.models.MarketHistory'>, k = 'market_share'

    def _declarative_constructor(self: Any, **kwargs: Any) -> None:
        """A simple constructor that allows initialization from kwargs.
    
        Sets attributes on the constructed instance using the names and
        values in ``kwargs``.
    
        Only keys that are present as
        attributes of the instance's class are allowed. These could be,
        for example, any mapped columns or relationships.
        """
        cls_ = type(self)
        for k in kwargs:
            if not hasattr(cls_, k):
>               raise TypeError(
                    "%r is an invalid keyword argument for %s" % (k, cls_.__name__)
                )
E               TypeError: 'market_share' is an invalid keyword argument for MarketHistory

..\venv\Lib\site-packages\sqlalchemy\orm\decl_base.py:2179: TypeError
=============================== tests coverage ================================
_______________ coverage: platform win32, python 3.13.5-final-0 _______________

Name                        Stmts   Miss  Cover   Missing
---------------------------------------------------------
app\__init__.py                 0      0   100%
app\database.py                10      2    80%   21-22
app\main.py                    23     23     0%   1-55
app\models.py                 128      0   100%
app\routers\__init__.py         2      2     0%   2-4
app\routers\ledger.py          66     66     0%   5-136
app\routers\ledger_api.py      75     75     0%   2-187
app\routers\simulation.py     131    131     0%   5-305
app\schemas.py                 75     75     0%   5-100
core\__init__.py                0      0   100%
core\accounting.py             62     62     0%   7-188
core\bot_ai.py                346    346     0%   7-673
core\engine.py                527    527     0%   7-1005
core\inventory_manager.py      56     19    66%   55-63, 76, 110-113, 144-155, 184-190
core\market.py                117    117     0%   7-278
core\market_events.py          71     71     0%   8-192
core\reports.py                52     52     0%   7-120
---------------------------------------------------------
TOTAL                        1741   1568    10%
=========================== short test summary info ===========================
FAILED tests/test_inventory_manager.py::TestInventoryManager::test_forecast_demand_no_history_with_market_avg
FAILED tests/test_inventory_manager.py::TestInventoryManager::test_forecast_demand_with_history
FAILED tests/test_inventory_manager.py::TestInventoryManager::test_forecast_demand_with_fewer_periods_than_requested
FAILED tests/test_inventory_manager.py::TestInventoryManager::test_forecast_demand_with_events_engine
FAILED tests/test_inventory_manager.py::TestInventoryManager::test_calculate_safety_stock_insufficient_data
FAILED tests/test_inventory_manager.py::TestInventoryManager::test_calculate_safety_stock_with_sufficient_data
FAILED tests/test_inventory_manager.py::TestInventoryManager::test_get_reorder_quantity_needs_reorder
FAILED tests/test_inventory_manager.py::TestInventoryManager::test_get_reorder_quantity_no_reorder_needed
FAILED tests/test_inventory_manager.py::TestInventoryManager::test_get_reorder_quantity_with_events_engine
FAILED tests/test_inventory_manager.py::TestInventoryManager::test_calculate_turnover_with_sales_and_inventory
FAILED tests/test_inventory_manager.py::TestInventoryManager::test_calculate_turnover_no_inventory
FAILED tests/test_inventory_manager.py::TestInventoryManager::test_calculate_turnover_zero_inventory
======================== 12 failed, 7 passed in 3.76s =========================
